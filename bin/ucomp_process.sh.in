#!/bin/sh

# This script launches IDL for the pipeline to process a day, both the
# realtime and end-of-day processing.

canonicalpath() {
  if [ -d $1 ]; then
    pushd $1 > /dev/null 2>&1
    echo $PWD
  elif [ -f $1 ]; then
    pushd $(dirname $1) > /dev/null 2>&1
    echo $PWD/$(basename $1)
  else
    echo "Invalid path $1"
  fi
  popd > /dev/null 2>&1
}

# u=rwx,g=rwx,o=rx
umask 0002

# find locations relative to this script
SCRIPT_LOC=$(canonicalpath $0)
BIN_DIR=$(dirname ${SCRIPT_LOC})
PIPE_DIR=$(dirname ${BIN_DIR})

MACHINE=$(hostname | sed -e 's/\..*$//')
if [[ $# -lt 1 ]]; then
  CONFIG=${PIPE_DIR}/config/ucomp.${USER}.${MACHINE}.production.cfg
  #CONFIG=${PIPE_DIR}/config/ucomp.${USER}.${MACHINE}.latest.cfg
else
  CONFIG=${PIPE_DIR}/config/ucomp.${USER}.${MACHINE}.${1}.cfg
fi

# use today if date not passed to script
if [[ $# -lt 2 ]]; then
  DATE=$(date +"%Y%m%d")
else
  DATE=$2
fi

IDL=@IDL_EXECUTABLE@

# IDL_DEFAULT will be wrong if IDL_DIR is set
unset IDL_DIR

# setup IDL paths
SSW_DIR=${PIPE_DIR}/ssw
GEN_DIR=${PIPE_DIR}/gen
LIB_DIR=${PIPE_DIR}/lib
SRC_DIR=${PIPE_DIR}/src
UCOMP_PATH=+${SRC_DIR}:${SSW_DIR}:${GEN_DIR}:+${LIB_DIR}:"<IDL_DEFAULT>"
UCOMP_DLM_PATH=${LIB_DIR}/mysql:"<IDL_DEFAULT>"

${IDL} -quiet \
    -IDL_QUIET 1 \
    -IDL_STARTUP "" \
    -IDL_PATH ${UCOMP_PATH} \
    -IDL_DLM_PATH ${UCOMP_DLM_PATH} \
    -e "ucomp_run_pipeline, '${DATE}', '${CONFIG}'"
